<div class="cartoes-classes">
    <header class="cc-header">
        <nav class="breadcrumb">
            <a routerLink="/dashboard" class="crumb">Início</a>
            <span class="sep">/</span>
            <span class="crumb current">Cartões de Classes</span>
        </nav>
        <div class="title-wrap">
            <h1 class="page-title">Cartões de Classe {{ classes[0]?.nome }}</h1>
            <p class="page-sub">Registre o que foi ministrado e quem cumpriu cada requisito.</p>
        </div>
    </header>

    <div *ngIf="!requisitos.length">Nenhum requisito encontrado.</div>

    <div *ngFor="let req of requisitos" class="req-item" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
        <div>
            <div class="req-main">
                <div class="req-text">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <strong>{{ req.categoria }}</strong>
                    </div>
                    <div>
                        <p>{{ req.descricao }}</p>
                    </div>
                    <div class="req-buttons">
                        <button *ngIf="!req.progresso?.length" (click)="toggleForm(req.id)">{{ showingFormForReq[req.id]
                            ?
                            'Cancelar' : 'Marcar' }}</button>
                        <button *ngIf="req.progresso?.length" (click)="toggleForm(req.id)">{{ showingFormForReq[req.id]
                            ?
                            'Cancelar' : 'Desmarcar' }}</button>
                    </div>
                </div>

            </div>

            <div *ngIf="showingFormForReq[req.id]" class="req-form">
                <p>Selecione os desbravadores que receberam a instrução:</p>
                <div *ngFor="let d of desbravadores">
                    <label>
                        <input type="checkbox" (change)="toggleDesbravadorSelection(req.id, d.id)" /> {{ d.name }}
                    </label>
                </div>
                <div class="actions">
                    <button *ngIf="!req.progresso?.length" (click)="marcar(req.id)"
                        [disabled]="isProcessingForReq[req.id]">{{ isProcessingForReq[req.id] ? 'Salvando...' :
                        'Confirmar'
                        }}</button>
                    <button *ngIf="req.progresso?.length" (click)="desmarcar(req.id)"
                        [disabled]="isProcessingForReq[req.id]">{{ isProcessingForReq[req.id] ? 'Removendo...' :
                        'Confirmar
                        remoção' }}</button>
                </div>
                <div *ngIf="messageForReq[req.id]" class="req-message">
                    <small>{{ messageForReq[req.id] }}</small>
                </div>
            </div>

            <div *ngIf="req.progresso?.length">
                <small>
                    Marcado por:
                    <span *ngFor="let p of req.progresso; let i = index">
                        {{ p.instrutor?.name || p.instrutorId || '—' }}
                        <span *ngIf="i < (req.progresso.length - 1)">, </span>
                    </span>
                </small>
                <div>
                    <small>Cumprido por: <span *ngFor="let p of req.progresso; let i = index">{{ p.desbravador?.name ||
                            p.desbravadorId }}<span *ngIf="i < (req.progresso.length - 1)">, </span></span></small>
                </div>
            </div>
        </div>
        <div class="req-check">
            <span *ngIf="req.progresso?.length" class="check">✓</span>
        </div>
    </div>
</div>