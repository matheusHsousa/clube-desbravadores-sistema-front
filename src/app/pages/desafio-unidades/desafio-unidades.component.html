<div class="page-desafio-unidades">
  <mat-card class="page-card">
    <mat-card-title>Desafio das Unidades</mat-card-title>
    <mat-card-content>
      <div *ngIf="auth.hasRole('ADMIN')" class="admin-panel">
        <h3>Criar novo desafio</h3>
        <div class="form-row">
          <mat-form-field appearance="outline" class="full">
            <mat-label>Título</mat-label>
            <input matInput placeholder="Título" [(ngModel)]="newTitle" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Prazo</mat-label>
            <input matInput type="date" [(ngModel)]="newDue" />
          </mat-form-field>
        </div>
        <mat-form-field appearance="outline" class="full">
          <mat-label>Descrição</mat-label>
          <textarea matInput rows="3" placeholder="Descrição" [(ngModel)]="newDescription"></textarea>
        </mat-form-field>
        <div class="actions">
          <button mat-flat-button color="primary" (click)="saveChallenge()">{{ editingId ? 'Salvar' : 'Criar'
            }}</button>
          <button *ngIf="editingId" mat-stroked-button color="warn" (click)="cancelEdit()">Cancelar</button>
        </div>

        <h3 style="margin-top:16px">Desafios criados</h3>
        <div *ngIf="(challenges?.length || 0) === 0">Nenhum desafio criado</div>
        <div *ngIf="(challenges.length || 0) > 0">
          <div class="created-table-wrapper">
            <div class="table-container">
              <table mat-table [dataSource]="dataSourceChallenges" class="created-table" matSort>

                <ng-container matColumnDef="title">
                  <th mat-header-cell *matHeaderCellDef>Título</th>
                  <td mat-cell *matCellDef="let c" [attr.data-label]="'Título'">{{ c.title }}</td>
                </ng-container>

                <ng-container matColumnDef="dueDate">
                  <th mat-header-cell *matHeaderCellDef>Prazo</th>
                  <td mat-cell *matCellDef="let c" [attr.data-label]="'Prazo'">{{ c.dueDate | date:'shortDate' }}</td>
                </ng-container>

                <ng-container matColumnDef="description">
                  <th mat-header-cell *matHeaderCellDef>Descrição</th>
                  <td mat-cell *matCellDef="let c" [attr.data-label]="'Descrição'">{{ c.description }}</td>
                </ng-container>

                <ng-container matColumnDef="acoes">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let c" [attr.data-label]="'Ações'">
                    <div class="row-actions">
                      <button mat-icon-button color="primary" (click)="editChallenge(c)" aria-label="Editar">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="warn" (click)="deleteChallenge(c)" aria-label="Excluir">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumnsChallenges"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumnsChallenges;"></tr>
              </table>
            </div>

            <mat-paginator [pageSizeOptions]="[10]" showFirstLastButtons></mat-paginator>
          </div>
        </div>

        <h3>Submissões pendentes</h3>
        <div *ngIf="(pending.length || 0) === 0">Nenhuma submissão pendente</div>

        <mat-card *ngIf="(pending.length || 0) > 0" class="section-card">
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="pending" class="pendentes-table">

                <ng-container matColumnDef="desafio">
                  <th mat-header-cell *matHeaderCellDef>Desafio</th>
                  <td mat-cell *matCellDef="let s">{{ s.desafioUnidade?.title }}</td>
                </ng-container>

                <ng-container matColumnDef="unidade">
                  <th mat-header-cell *matHeaderCellDef>Unidade</th>
                  <td mat-cell *matCellDef="let s">{{ s.unitid || s.unidade }}</td>
                </ng-container>

                <ng-container matColumnDef="data">
                  <th mat-header-cell *matHeaderCellDef>Enviado</th>
                  <td mat-cell *matCellDef="let s">{{ formatarData(s.createdat || s.createdAt) }}</td>
                </ng-container>

                <ng-container matColumnDef="preview">
                  <th mat-header-cell *matHeaderCellDef>Preview</th>
                  <td mat-cell *matCellDef="let s">
                    <img
                      *ngIf="s.fileurl && (s.fileurl.includes('.jpg') || s.fileurl.includes('.png') || s.fileurl.includes('.gif') || s.fileurl.includes('.jpeg') || s.fileurl.includes('.webp'))"
                      [src]="s.fileurl" class="thumbnail clickable" (click)="openMedia(s.fileurl, false)" />
                    <video
                      *ngIf="s.fileurl && !(s.fileurl.includes('.jpg') || s.fileurl.includes('.png') || s.fileurl.includes('.gif') || s.fileurl.includes('.jpeg') || s.fileurl.includes('.webp'))"
                      [src]="s.fileurl" muted preload="metadata" class="thumbnail clickable"
                      (click)="openMedia(s.fileurl, true)"></video>
                  </td>
                </ng-container>

                <ng-container matColumnDef="comentario">
                  <th mat-header-cell *matHeaderCellDef>Comentário</th>
                  <td mat-cell *matCellDef="let s">{{ s.comment }}</td>
                </ng-container>

                <ng-container matColumnDef="nota">
                  <th mat-header-cell *matHeaderCellDef>Nota</th>
                  <td mat-cell *matCellDef="let s">
                    <mat-form-field appearance="outline" class="note-field">
                      <input matInput type="number" min="0" max="10" [(ngModel)]="approvalNotes[s.id]" />
                    </mat-form-field>
                  </td>
                </ng-container>

                <ng-container matColumnDef="acoes">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let s">
                    <button mat-icon-button color="primary" (click)="approve(s)" matTooltip="Aprovar">
                      <mat-icon>check</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="reject(s)" matTooltip="Recusar">
                      <mat-icon>close</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumnsPendentes"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumnsPendentes;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>

        <div class="image-overlay" *ngIf="selectedMediaUrl" (click)="closeMedia()">
          <button class="close-btn" (click)="closeMedia(); $event.stopPropagation()">Fechar</button>
          <img *ngIf="!selectedMediaIsVideo" [src]="selectedMediaUrl" alt="Pré-visualização" class="preview"
            (click)="$event.stopPropagation()">
          <video *ngIf="selectedMediaIsVideo" #modalVideo [src]="selectedMediaUrl" controls class="preview"
            (click)="$event.stopPropagation()" crossorigin="anonymous" [muted]="selectedMediaAutoMuted"
            autoplay></video>
          <a class="close-btn" style="right:110px; background:rgba(0,0,0,0.6);" target="_blank"
            [href]="selectedMediaUrl">Abrir em nova aba</a>
        </div>
      </div>

      <div *ngIf="showAvailableSection" class="conselheiro-panel">
        <h3>Desafios disponíveis</h3>
        <div class="meus-desafios" style="margin-bottom:12px;">
          <h4>Meus Desafios</h4>
          <div *ngIf="(mySubmissions?.length || 0) === 0" class="empty">Nenhuma submissão enviada</div>
          <div *ngIf="(mySubmissions?.length || 0) > 0" class="table-container">
            <table class="status-table">
              <thead>
                <tr>
                  <th>Desafio</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let s of mySubmissions">
                  <td>{{ s.desafioUnidade?.title || s.desafiounidade?.title || '—' }}</td>
                  <td>
                    <span class="status-badge" [ngClass]="{ 'approved': s.aprovado === true, 'pending': s.aprovado !== true }">
                      <ng-container *ngIf="s.aprovado === true">Aprovado ({{ s.nota ?? s.score ?? s.pontuacao ?? '-' }})</ng-container>
                      <ng-container *ngIf="s.aprovado !== true">Pendente</ng-container>
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div *ngIf="availableChallenges.length === 0">Nenhum desafio encontrado</div>
        <div class="challenge-grid">
          <mat-card *ngFor="let c of availableChallenges" class="challenge-card">
            <mat-card-header style="display: flex;">
              <div>
                <mat-card-title>{{ c.title }}</mat-card-title>
                <mat-card-subtitle>Prazo: {{ c.dueDate | date:'shortDate' }}</mat-card-subtitle>
              </div>

              <div class="preview" *ngIf="!selectedFor[c.id]" style="width: 90px; height: 90px; border:1px dashed #1976d2; border-radius: 10px; display:flex; align-items:center; justify-content:center; margin-left: auto;">
              </div>

              <div class="preview" style="width: 90px; height: 90px; border-radius: 10px; display:flex; align-items:center; justify-content:center; margin-left: auto;" *ngIf="selectedFor[c.id]">
                <img *ngIf="selectedFor[c.id]?.isImage" [src]="selectedFor[c.id]?.previewUrl" alt="preview" />
                <video *ngIf="!selectedFor[c.id]?.isImage" [src]="selectedFor[c.id]?.previewUrl" controls></video>
              </div>
            </mat-card-header>
            <mat-card-content>
              <p>{{ c.description }}</p>


              <mat-form-field appearance="outline" class="full">
                <mat-label>Comentário (opcional)</mat-label>
                <textarea matInput rows="2" [(ngModel)]="comments[c.id]"></textarea>
              </mat-form-field>
              <div class="submit-row" style="margin-bottom: 22px;">
                <input id="file-{{c.id}}" type="file" (change)="onFileChange($event, c)" accept="image/*,video/*" hidden
                  [attr.aria-describedby]="'file-hint-'+c.id" />
                <label for="file-{{c.id}}" class="choose-file" aria-label="Escolher arquivo" role="button" tabindex="0"
                  (keydown.enter)="triggerFileInput(c.id)" (keydown.space)="triggerFileInput(c.id)">
                  <mat-icon>attach_file</mat-icon>
                  <span>Escolher arquivo</span>
                </label>
              </div>

              <div class="submit-actions">
                <button mat-flat-button color="primary" [disabled]="uploadingFor[c.id] || !(selectedFor[c.id]?.file)"
                  (click)="uploadMedia(c)">
                  <span>Enviar arquivo</span>
                </button>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>