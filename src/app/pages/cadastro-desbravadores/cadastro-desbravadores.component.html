<div class="cadastro">
  <div class="cadastro__header">
    <div>
      <div class="cadastro__title">Cadastro de Desbravadores</div>
      <div class="cadastro__subtitle">Adicione e gerencie os desbravadores do clube</div>
    </div>
  </div>

  <div class="cadastro__body">
    <div class="cadastro__form">
      <form [formGroup]="form" (ngSubmit)="submit()">
        <div class="form-grid">
          <mat-form-field appearance="outline" class="full">
            <mat-label>Nome</mat-label>
            <input matInput formControlName="name" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Data de Nascimento</mat-label>
            <input matInput type="date" formControlName="birthDate" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Unidade</mat-label>
            <mat-select formControlName="unidade">
              <mat-option *ngFor="let u of unidades" [value]="u">{{ u }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Classe</mat-label>
            <mat-select formControlName="classe">
              <mat-option *ngFor="let c of classes" [value]="c">{{ c }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button mat-stroked-button type="button" class="btn" (click)="form.reset()">Limpar</button>
          <button mat-flat-button color="primary" type="submit" class="btn btn--primary" [disabled]="form.invalid">Cadastrar</button>
        </div>
      </form>

      <h3 class="section-title">Desbravadores cadastrados</h3>
      <div class="desb-toolbar">
        <input class="search-input" placeholder="Buscar por nome" type="search" [value]="filterName" (input)="setFilter($any($event.target).value)" />
        <button *ngIf="filterName" type="button" class="btn btn--plain" (click)="setFilter('')">Limpar</button>
        <div class="import-block">
          <input type="file" accept=".xlsx,.csv" (change)="handleFile($event)" />
        </div>
      </div>

      <div *ngIf="previewRows && previewRows.length" class="import-preview">
        <h4>Pré-visualização / Revisão</h4>
        <div>
          <label><input type="checkbox" (change)="toggleSelectAll($any($event.target).checked)" /> Selecionar todos</label>
        </div>
        <table class="preview-table">
          <thead>
            <tr>
              <th></th>
              <th>Nome</th>
              <th>Nascimento</th>
              <th>Unidade</th>
              <th>Classe</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of previewRows; let i = index">
              <td><input type="checkbox" [(ngModel)]="r.selected" /></td>
              <td><input type="text" [value]="r.name" (input)="updatePreviewField(r,'name',$any($event.target).value)" /></td>
              <td><input type="date" [value]="r.birthDate" (input)="updatePreviewField(r,'birthDate',$any($event.target).value)" /></td>
              <td>
                <select [value]="r.unidade" (change)="updatePreviewField(r,'unidade',$any($event.target).value)">
                  <option *ngFor="let u of unidades" [value]="u">{{ u }}</option>
                </select>
              </td>
              <td>
                <select [value]="r.classe" (change)="updatePreviewField(r,'classe',$any($event.target).value)">
                  <option *ngFor="let c of classes" [value]="c">{{ c }}</option>
                </select>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="preview-actions">
          <button mat-stroked-button type="button" (click)="cancelPreview()">Cancelar</button>
          <button mat-flat-button color="primary" type="button" (click)="importSelected()">Importar selecionados</button>
        </div>
      </div>

      <div *ngIf="loading">Carregando...</div>
      <ul *ngIf="!loading" class="desb-list">
        <li *ngFor="let d of filteredDesbravadores" class="desb-item">
          <div class="avatar">{{ initials(d.name) }}</div>

          <div class="desb-info">
            <div *ngIf="!d._editing">
              <div class="desb-name">{{ d.name }}</div>
              <div class="desb-meta muted">{{ d.unidade || '—' }} — {{ d.classe || '—' }}</div>
            </div>

            <div *ngIf="d._editing" class="edit-inline">
                <input type="text" [value]="d._editCopy.name" (input)="updateEdit(d,'name',$any($event.target).value)" />
                <input type="date" [value]="d._editCopy.birthDate" (input)="updateEdit(d,'birthDate',$any($event.target).value)" />
            </div>
          </div>

          <div class="desb-actions">
            <button *ngIf="!d._editing" type="button" class="btn btn--plain" (click)="toggleEdit(d)">Editar</button>
            <button *ngIf="!d._editing" type="button" class="btn btn--danger" (click)="remove(d)">Remover</button>
            <button *ngIf="d._editing" type="button" class="btn btn--primary" (click)="save(d)">Salvar</button>
            <button *ngIf="d._editing" type="button" class="btn btn--secondary" (click)="cancelEdit(d)">Cancelar</button>
          </div>
        </li>
      </ul>
    </div>

    <aside class="aside">
      <div class="helper">Dica: use buscas rápidas para encontrar desbravadores.</div>
    </aside>
  </div>
</div>
